# 阶段5：集成 LSH（近似相似簇）

目的
- 在阶段4的频次直方图（CMS）与去重设备计数（HLL）基础上，引入“相似簇”的视角：
  - 用随机超平面 LSH（SRPLSH）将相似特征聚到同一桶
  - 检查“大桶”（size ≥ min_size）是否异常活跃，辅助识别“群体性异常”或某类设备的集中偏差

特征设计（默认）
- `[reading_hat, confidence, delta(占位), risk_multiplier]`
- 后续可把 `delta` 替换为“本条与区域基线的偏差”或“环比变化”等

主要接口
- `Pipeline.lsh.insert(features, sensor_id)`: 流式插入，构建近似相似桶
- `Pipeline.get_lsh_bucket_stats(top_k=10, min_size=3)`: 返回跨所有表的大桶（包含均值与示例 ID），用于窗口内可视化与筛查

参数建议
- `num_bits`（每表签名位数）：增大可细分桶（更小、更纯），但召回下降；常用 16–24
- `num_tables`（表数）：增大可提升召回（不同随机集合），但内存与插入成本增加；常用 3–8
- 结合 CMS/HLL：
  - 当某区域的“重频桶”与 LSH 的“大簇”同时活跃，且 HLL 的去重设备数上升，往往提示群体性异常
  - 若 LSH 大簇出现，但 HLL 设备数不变，可能是少数设备多次触发（需要进一步定位）

边界与注��
- LSH 的桶是“近似相似”，非严格聚类；应作为候选筛选，再配合下游评估
- SRP 的距离对应余弦相似度的近似；若特征量纲差异大，建议做标准化或加权
- 在数据分布明显非线性或多模态时，考虑多种特征工程或多表组合策略

# LSH 配置示例（添加到你的 pipeline 配置）

```yaml
lsh:
  dim: 4          # 特征维度，默认 [reading_hat, confidence, delta, risk_multiplier]
  num_bits: 16    # 每表签名位数
  num_tables: 4   # 表数量
  seed: 42        # 随机种子
```

说明：
- 若你扩展特征向量维度（例如加入区域基线偏差、历史滑窗均值等），请同步调整 `dim`。
- `num_bits` 越大，桶更细（更纯），但召回变低；`num_tables` 越多，召回更高但资源增加。


随机超平面 LSH 要求你先把每条记录的 features 组成固定维度的数值向量，然后对这个向量计算“签名”（每张表一串二进制位），用签名把样本放进对应的“签名桶”。签名用于近似相似性索引，原始向量通常也会一起存着，便于后续精排或统计。

流程概览

组装向量：features → 向量 x ∈ R^d（例如 [reading_hat, confidence, delta, risk_multiplier]）。
计算签名（每张表 t）：
取 num_bits 条随机超平面 r_k（高斯随机向量）。
逐条求符号位 b_k = 1[x·r_k ≥ 0]。
拼成签名串 sig_t = b_1 b_2 … b_K。
入桶：用 sig_t 作为 key，把 (item_id, 向量) 加到表 t 的该签名桶里。
查询：对查询向量同样算签名，到各表的同签名桶取候选，再去重；必要时用真实距离做再筛选/排序。
小例子

x1 = [150, 0.80, 0.0, 1.3] → 表0签名可能是 "1011001000100110"
x2 = [151, 0.78, 0.0, 1.3]（与 x1 很相似）→ 表0签名大概率相同或只有少数位不同；在多表设置下仍易被召回为候选。
注意事项

特征需数值型、维度一致；建议标准化/归一化，避免量纲差异导致点积符号��某一维主导。
签名长度（num_bits）越大，桶更细更纯但召回下降；表数（num_tables）越多，召回更高但资源增加。
LSH 的“表/桶”仅用于相似性检索，和 CMS 的频次统计结构无关。